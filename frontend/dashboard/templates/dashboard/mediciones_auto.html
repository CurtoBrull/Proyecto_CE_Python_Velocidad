{% extends 'dashboard/base.html' %}

{% block title %}Mediciones Automaticas - Radar de Velocidad{% endblock %}

{% block extra_css %}
<style>
    .status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 8px;
    }
    .status-connected { background-color: #28a745; }
    .status-disconnected { background-color: #dc3545; }
    .status-waiting { background-color: #ffc107; animation: pulse 1.5s infinite; }

    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }

    .velocidad-display {
        font-size: 4rem;
        font-weight: 700;
        line-height: 1;
    }
    .velocidad-normal { color: var(--success); }
    .velocidad-exceso { color: var(--danger); }

    .sensor-status {
        padding: 1.5rem;
        border-radius: 12px;
        text-align: center;
        transition: all 0.3s ease;
    }
    .sensor-esperando-1 {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }
    .sensor-esperando-2 {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
        animation: pulse-bg 1.5s infinite;
    }

    @keyframes pulse-bg {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.8; }
    }

    .medicion-card {
        transition: all 0.3s ease;
    }
    .medicion-card.nueva {
        animation: highlight 1s ease;
    }
    @keyframes highlight {
        0% { background-color: rgba(40, 167, 69, 0.3); }
        100% { background-color: transparent; }
    }
</style>
{% endblock %}

{% block content %}
<!-- Header de pagina -->
<div class="page-header">
    <h1><i class="bi bi-broadcast"></i> Mediciones Automaticas</h1>
    <p class="subtitle">Monitoreo en tiempo real de las mediciones de la placa ESP32</p>
</div>

<div class="row">
    <!-- Estado del sistema -->
    <div class="col-lg-4 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0">
                    <span class="status-indicator status-connected" id="connection-status"></span>
                    Estado del Sistema
                </h5>
            </div>
            <div class="card-body">
                <div class="sensor-status {% if estado == 'esperando_sensor2' %}sensor-esperando-2{% else %}sensor-esperando-1{% endif %}" id="sensor-status">
                    <i class="bi bi-broadcast fs-1 mb-3 d-block"></i>
                    <h4 class="mb-2" id="sensor-status-text">
                        {% if estado == 'esperando_sensor2' %}
                        Esperando Sensor 2
                        {% else %}
                        Esperando Sensor 1
                        {% endif %}
                    </h4>
                    <small id="sensor-status-desc">
                        {% if estado == 'esperando_sensor2' %}
                        Objeto detectado en sensor 1, esperando paso por sensor 2...
                        {% else %}
                        Sistema listo. Esperando deteccion en sensor 1...
                        {% endif %}
                    </small>
                </div>

                <div class="mt-4">
                    <table class="table table-sm table-borderless mb-0">
                        <tr>
                            <td class="text-muted">Distancia:</td>
                            <td class="text-end"><strong>{{ distancia_actual }} m</strong></td>
                        </tr>
                        <tr>
                            <td class="text-muted">Limite:</td>
                            <td class="text-end"><span class="badge bg-danger">{{ limite_velocidad }} km/h</span></td>
                        </tr>
                        <tr>
                            <td class="text-muted">Actualizacion:</td>
                            <td class="text-end"><span id="last-update">--</span></td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Ultima velocidad -->
    <div class="col-lg-4 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-speedometer2 me-2"></i>Ultima Velocidad</h5>
            </div>
            <div class="card-body text-center d-flex flex-column justify-content-center">
                <div class="velocidad-display velocidad-normal" id="ultima-velocidad">
                    {% if ultimas_mediciones %}
                        {{ ultimas_mediciones.0.velocidad_kmh|floatformat:1 }}
                    {% else %}
                        --
                    {% endif %}
                </div>
                <div class="fs-4 text-muted">km/h</div>
                <div class="mt-3" id="velocidad-status">
                    {% if ultimas_mediciones and ultimas_mediciones.0.exceso %}
                        <span class="badge bg-danger fs-6"><i class="bi bi-exclamation-triangle me-1"></i>EXCESO</span>
                    {% elif ultimas_mediciones %}
                        <span class="badge bg-success fs-6"><i class="bi bi-check-circle me-1"></i>Normal</span>
                    {% endif %}
                </div>
                <div class="mt-2 text-muted small" id="ultima-timestamp">
                    {% if ultimas_mediciones %}
                        {{ ultimas_mediciones.0.timestamp|slice:":16"|cut:"T" }}
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Grafico en vivo -->
    <div class="col-lg-4 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-graph-up me-2"></i>Ultimas Mediciones</h5>
            </div>
            <div class="card-body">
                <canvas id="velocidadChart" height="200"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Historial reciente -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-clock-history me-2"></i>Historial Reciente</h5>
                <span class="badge bg-secondary" id="mediciones-count">{{ ultimas_mediciones|length }} mediciones</span>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Hora</th>
                                <th>Velocidad</th>
                                <th>Tiempo</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody id="mediciones-tbody">
                            {% for medicion in ultimas_mediciones %}
                            <tr class="medicion-card">
                                <td>{{ medicion.timestamp|slice:":19"|cut:"T" }}</td>
                                <td>
                                    <strong class="{% if medicion.exceso %}text-danger{% else %}text-success{% endif %}">
                                        {{ medicion.velocidad_kmh|floatformat:2 }} km/h
                                    </strong>
                                </td>
                                <td>{{ medicion.tiempo_recorrido|floatformat:2 }}s</td>
                                <td>
                                    {% if medicion.exceso %}
                                        <span class="badge bg-danger">Exceso</span>
                                    {% else %}
                                        <span class="badge bg-success">Normal</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="4" class="text-center text-muted py-4">
                                    <i class="bi bi-inbox fs-3 d-block mb-2"></i>
                                    No hay mediciones recientes
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Info de conexion -->
<div class="row mt-4">
    <div class="col-12">
        <div class="alert alert-info">
            <i class="bi bi-info-circle me-2"></i>
            <strong>Conexion con la placa:</strong> Esta pagina se actualiza automaticamente cada 2 segundos.
            Asegurate de que la placa ESP32 este conectada y enviando datos a la API en
            <code>{{ api_url }}/mediciones/</code>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const LIMITE_VELOCIDAD = {{ limite_velocidad }};
let velocidadChart;
let ultimasMediciones = [];
let ultimoId = {% if ultimas_mediciones %}{{ ultimas_mediciones.0.id|default:0 }}{% else %}0{% endif %};

// Inicializar grafico
function initChart() {
    const ctx = document.getElementById('velocidadChart').getContext('2d');
    velocidadChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Velocidad (km/h)',
                data: [],
                borderColor: '#667eea',
                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                fill: true,
                tension: 0.4
            }, {
                label: 'Limite',
                data: [],
                borderColor: '#dc3545',
                borderDash: [5, 5],
                pointRadius: 0,
                fill: false
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    max: Math.max(LIMITE_VELOCIDAD * 2, 100)
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });

    // Cargar datos iniciales
    {% for medicion in ultimas_mediciones reversed %}
    velocidadChart.data.labels.push('{{ medicion.timestamp|slice:"11:16" }}');
    velocidadChart.data.datasets[0].data.push({{ medicion.velocidad_kmh|floatformat:2 }});
    velocidadChart.data.datasets[1].data.push(LIMITE_VELOCIDAD);
    {% endfor %}
    velocidadChart.update();
}

// Actualizar estado
function actualizarEstado(data) {
    const statusDiv = document.getElementById('sensor-status');
    const statusText = document.getElementById('sensor-status-text');
    const statusDesc = document.getElementById('sensor-status-desc');

    if (data.estado === 'esperando_sensor2') {
        statusDiv.className = 'sensor-status sensor-esperando-2';
        statusText.textContent = 'Esperando Sensor 2';
        statusDesc.textContent = 'Objeto detectado en sensor 1, esperando paso por sensor 2...';
    } else {
        statusDiv.className = 'sensor-status sensor-esperando-1';
        statusText.textContent = 'Esperando Sensor 1';
        statusDesc.textContent = 'Sistema listo. Esperando deteccion en sensor 1...';
    }

    document.getElementById('last-update').textContent = new Date().toLocaleTimeString();
}

// Actualizar velocidad
function actualizarVelocidad(medicion) {
    const velocidadDisplay = document.getElementById('ultima-velocidad');
    const velocidadStatus = document.getElementById('velocidad-status');
    const timestamp = document.getElementById('ultima-timestamp');

    if (medicion) {
        velocidadDisplay.textContent = medicion.velocidad_kmh.toFixed(1);
        velocidadDisplay.className = 'velocidad-display ' +
            (medicion.exceso ? 'velocidad-exceso' : 'velocidad-normal');

        if (medicion.exceso) {
            velocidadStatus.innerHTML = '<span class="badge bg-danger fs-6"><i class="bi bi-exclamation-triangle me-1"></i>EXCESO</span>';
        } else {
            velocidadStatus.innerHTML = '<span class="badge bg-success fs-6"><i class="bi bi-check-circle me-1"></i>Normal</span>';
        }

        timestamp.textContent = medicion.timestamp.replace('T', ' ').slice(0, 16);
    }
}

// Actualizar tabla
function actualizarTabla(mediciones) {
    const tbody = document.getElementById('mediciones-tbody');
    const count = document.getElementById('mediciones-count');

    if (mediciones.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="4" class="text-center text-muted py-4">
                    <i class="bi bi-inbox fs-3 d-block mb-2"></i>
                    No hay mediciones recientes
                </td>
            </tr>
        `;
        count.textContent = '0 mediciones';
        return;
    }

    let html = '';
    mediciones.forEach((m, index) => {
        const isNew = m.id > ultimoId;
        html += `
            <tr class="medicion-card ${isNew ? 'nueva' : ''}">
                <td>${m.timestamp.replace('T', ' ').slice(0, 19)}</td>
                <td>
                    <strong class="${m.exceso ? 'text-danger' : 'text-success'}">
                        ${m.velocidad_kmh.toFixed(2)} km/h
                    </strong>
                </td>
                <td>${m.tiempo_recorrido ? m.tiempo_recorrido.toFixed(2) : '--'}s</td>
                <td>
                    ${m.exceso ?
                        '<span class="badge bg-danger">Exceso</span>' :
                        '<span class="badge bg-success">Normal</span>'
                    }
                </td>
            </tr>
        `;
    });

    tbody.innerHTML = html;
    count.textContent = mediciones.length + ' mediciones';

    // Actualizar ultimoId
    if (mediciones.length > 0 && mediciones[0].id > ultimoId) {
        ultimoId = mediciones[0].id;
    }
}

// Actualizar grafico
function actualizarGrafico(mediciones) {
    if (!velocidadChart || mediciones.length === 0) return;

    const labels = [];
    const data = [];
    const limite = [];

    mediciones.slice().reverse().forEach(m => {
        labels.push(m.timestamp.slice(11, 16));
        data.push(m.velocidad_kmh);
        limite.push(LIMITE_VELOCIDAD);
    });

    velocidadChart.data.labels = labels;
    velocidadChart.data.datasets[0].data = data;
    velocidadChart.data.datasets[1].data = limite;
    velocidadChart.update();
}

// Polling
async function poll() {
    try {
        const response = await fetch('{% url "dashboard:mediciones_auto_api" %}');
        const data = await response.json();

        document.getElementById('connection-status').className = 'status-indicator status-connected';

        actualizarEstado(data);

        if (data.ultimas_mediciones && data.ultimas_mediciones.length > 0) {
            actualizarVelocidad(data.ultimas_mediciones[0]);
            actualizarTabla(data.ultimas_mediciones);
            actualizarGrafico(data.ultimas_mediciones);
        }
    } catch (error) {
        console.error('Error polling:', error);
        document.getElementById('connection-status').className = 'status-indicator status-disconnected';
    }
}

// Iniciar
document.addEventListener('DOMContentLoaded', () => {
    initChart();
    setInterval(poll, 2000);
});
</script>
{% endblock %}
